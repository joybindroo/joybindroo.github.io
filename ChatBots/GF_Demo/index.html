<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Help Bot</title>
    <link rel="stylesheet" href="cb_style.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"> </script>

<script>
var currentDate = new Date();
var year = currentDate.getFullYear();
var month = currentDate.getMonth() + 1; 
var day = currentDate.getDate();
var hours = currentDate.getHours();
var minutes = currentDate.getMinutes();
var seconds = currentDate.getSeconds();

var chat_log  = '<h2>AI Help ChatBot - Exported Chat</h2><br/><b>Chat Time:' +year + '-' + month + '-' + day + ' ' + hours + ':' + minutes + ':' + seconds+'</b><br/><hr/>';
    function exportToPDF() {
    if(!chat_done){ alert('Please start chatting first!'); return;}

  
    disable_actions();

            const element=chat_log+'<br/><hr/>The End.<hr/>';
            const options = {
                filename: 'ExportedChat.pdf',
                margin: 0.5,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { 
                    unit: 'in', 
                    format: 'a3', 
                    orientation: 'portrait' ,                  
                    pagebreak: 'avoid-all',
                }
            };
              
            html2pdf().set(options).from(element).save();
            
    enable_actions();

}


function disable_actions(){
            const fetchButton = document.getElementById('send_button');
            const docu_selec=document.getElementById('sel_doc');
            
            const ebtn=document.getElementById('exp_btn');

            
            
            // Disable the action items
            fetchButton.disabled = true;
            docu_selec.disabled = true;
            ebtn.disabled = true;

            for(var i=0; i<8; i++){
                const sgb=document.getElementById('sgb'+i);
                sgb.disabled = true;

            }
}


function enable_actions(){
    // Enable the action items        
            const fetchButton = document.getElementById('send_button');
            const docu_selec=document.getElementById('sel_doc');
           
            const ebtn=document.getElementById('exp_btn');
           
            
            
            fetchButton.disabled = false;
            docu_selec.disabled = false;
            
            ebtn.disabled = false;

            for(var i=0; i<8; i++){
                const sgb=document.getElementById('sgb'+i);
                sgb.disabled = false;

            }
    
}




</script>


</head>
<body>
    <div id="chat_container" class="chat-container">
        <div class="chat-header">
            AI Help ChatBot
           
        </div>
    
        <div class="chat-messages" id="chat-messages">
            
        </div>

        <div id="action_items">
        <div id="doc_box" class="doc-box">
            
                &#128209; Change Document<br>
              
                
                <select onchange="show_docu_msg()" name="sel_doc" id="sel_doc">
                       
                <option value="81fba358-4bb4-11ee-b934-0b9cbc0d55f9"  >Exit Policy for Fellows</option>
                 <option value="d877f36c-4bb4-11ee-8412-f5c8f74a2ffb"  >FAQs for Fellowship and SMF Group</option>
                 <option value="060b1d36-4bb5-11ee-8412-f5c8f74a2ffb"  >Fellow Transfer Policy_Doc. Final</option>
                 <option value="36cd3698-4bb5-11ee-8412-f5c8f74a2ffb" selected=1 >Fellowship Handbook</option>
                 <option value="7097f462-4bb5-11ee-8412-f5c8f74a2ffb"  >Leave Policy</option>
                  
                </select>
            
        </div>
        
        <div id="suggest-box" class="suggest-box">
           &#128161; Query Hints<br/>
            <button id='sgb0' class="suggestion-button" onclick="load_suggestion('Introduction')">Introduction</button>
            <button id='sgb1' class="suggestion-button" onclick="load_suggestion('Summarize document')">Summarize Doc.</button>
            <button id='sgb2' class="suggestion-button" onclick="load_suggestion('List all chapters')">List Chapters</button>
            <button id='sgb3' class="suggestion-button" onclick="load_suggestion('Important key terms & concepts')">Terms & Concepts</button>
            <button id='sgb4' class="suggestion-button" onclick="load_suggestion('Key points')">Key Points</button>
            <button id='sgb5' class="suggestion-button" onclick="load_suggestion('Specific recommendations')">Recommendations</button>
            <button id='sgb6' class="suggestion-button" onclick="load_suggestion('Important findings')">Findings</button>
            <button id='sgb7' class="suggestion-button" onclick="load_suggestion('Observations mentioned throughout the text')">Observations</button>
            
        </div>

        <div class="message-input-container">
            
                <textarea class="message-input" id="user-input" placeholder="Type your query..."></textarea>
                <button id="send_button" class="send-button" onclick="sendMessage()">ASK</button>

        </div>   
    </div>     
            <div id="bottom_box" class="bottom-box">
                <div id="wbox" class="w-box">
                    &#9889; Ready

                </div>
<div><small>
               <b> Change AI:</b>&nbsp;
                <select name="LLM" id="LLM">
                <option value="langchain-gpt3-5" selected=1 >Langchain GPT3.5</option> 
                <option value="langchain-gpt4" >Langchain GPT4</option>
                
                </select>
                        
<button id="exp_btn" class='exp-btn' onclick="exportToPDF()">Export Chat to PDF</button>
       
                </small>

                 <button id="abt_btn" class="abt-btn" onclick="about()" >About</button>

            </div>
  </div>
</div>
          
        </div>
    </div>

    <script>

    var chat_done=false;                
    appendMessage('<b>&#128400; Hello! <br>&#129302; I am AI Help ChatBot.</b>','bot');
    appendMessage('I can tell you about the information available in the currently selected document: <br> <b>&#128209;'+get_selected_text('sel_doc')+'</b>','bot');
    appendMessage('What do you want to know?','bot');
            
    
                
   

    function about(){
        alert('AI Help Chatbot Web App uses LLMs powered by Jugalbandi.AI API\n\n Author: Joy Bindroo \n Org.: Piramal Foundation \n Team: BIDA\n email: jbindroo@piramalswasthya.org');
    }
    



    function get_selected_text(ipID) {
            const selectElement = document.getElementById(ipID);
            const selectedIndex = selectElement.selectedIndex;

            if (selectedIndex !== -1) { // Check if an option is selected
                const selectedOption = selectElement.options[selectedIndex];
                const selectedText = selectedOption.textContent;

                return(selectedText);
                
            } else {
                return('');
            }
        }

    function show_docu_msg(){
        appendMessage('<hr/>&#129302; :<br> You selected document:<br/> <b>&#128209; '+get_selected_text('sel_doc')+'</b><br/><br/>How can I help you in learning information available in this document?','bot')
    }

    function appendMessage(message, sender) {
            const chatMessages = document.getElementById('chat-messages');
            const messageElement = document.createElement('div');
            messageElement.className = sender + '-message';
            // messageElement.textContent = message;
            messageElement.innerHTML = message;
            chat_log+='<br/><br/>'+message;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    
    
    

    async function fetchResponse(userInput, LLM_Input,uuid_num) {
            const url = 'https://api.jugalbandi.ai/query-with-'; 
            const query = new URLSearchParams({ query_string: userInput });
            const jugal_doc_id = new URLSearchParams({ uuid_number: uuid_num });

            try {
                const response = await fetch(url +LLM_Input+ '?' + query + '&'+jugal_doc_id);

                const data = await response.json();
                return data.answer;
            } catch (error) {
                console.error(':( Error fetching response:', error);
                return ':( Sorry, there was an error processing your request.';
            }
        }

    

       async  function sendMessage() {
            
            
            const userInput = document.getElementById('user-input').value;


            if (userInput.trim() === '') return;

      

            disable_actions();
           
            const LLM_Input = document.getElementById('LLM').value;
            const uuid_num = document.getElementById('sel_doc').value;

            appendMessage('&#128373; : '+userInput, 'user');
            document.getElementById('wbox').innerHTML="<img height='20px' src='Hourglass.gif'></img><b> Working...</b>";
            const response = await fetchResponse(userInput,LLM_Input,uuid_num);
            document.getElementById('wbox').innerHTML="&#9889; Ready";
            appendMessage('&#129302; : '+response, 'bot');

        

            enable_actions();

            if(!chat_done)
            {chat_done=true;}
        }


        function load_suggestion(qry) {
          
            const typstr=document.getElementById('user-input');
            typstr.value=qry;
            sendMessage();

        }



    </script>


</body>

</html>
